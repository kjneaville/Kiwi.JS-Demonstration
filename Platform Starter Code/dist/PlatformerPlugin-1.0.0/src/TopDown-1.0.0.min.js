var PlatformState=new Kiwi.State("PlatformState");PlatformState.create=function(){this.camera=this.game.cameras.defaultCamera,this.game.stage.color="ffffff",this.generateTileMap(),this.tileWidth=48,this.tileHeight=48,this.jumpCount=2,this.jumps=0,this.jumpReleased=!0,this.sloping=!0,this.player=new PlayerSprite(this,this.textures.player,0,0),this.player.animation.add("walking",[1,2,3,4,5,6],.1,!0,!0),this.player.animation.add("idle",[0],.1,!0,!0),this.player.animation.add("goingUp",[8],.1,!0,!0),this.player.animation.add("goingDown",[9],.1,!0,!0),this.player.physics.acceleration.y=30,this.addChild(this.player),this.px=this.player.x+this.player.box.bounds.width/2,this.py=this.player.y+this.player.height,this.generateForegroundTileMap(),this.controllerActive=!0,this.controllerActive&&this.generateController()},PlatformState.generateController=function(){this.upButton=new Kiwi.Plugins.GameObjects.TouchButton(this,this.textures.upButton,81,300),this.upButton.posX=this.upButton.x,this.upButton.posY=this.upButton.y,this.addChild(this.upButton),this.downButton=new Kiwi.Plugins.GameObjects.TouchButton(this,this.textures.downButton,81,441),this.downButton.posX=this.downButton.x,this.downButton.posY=this.downButton.y,this.addChild(this.downButton),this.leftButton=new Kiwi.Plugins.GameObjects.TouchButton(this,this.textures.leftButton,26,360),this.leftButton.posX=this.leftButton.x,this.leftButton.posY=this.leftButton.y,this.addChild(this.leftButton),this.rightButton=new Kiwi.Plugins.GameObjects.TouchButton(this,this.textures.rightButton,162,360),this.rightButton.posX=this.rightButton.x,this.rightButton.posY=this.rightButton.y,this.addChild(this.rightButton)},PlatformState.updateController=function(){this.upButton.x=this.upButton.posX-this.camera.transform.x,this.upButton.y=this.upButton.posY-this.camera.transform.y,this.downButton.x=this.downButton.posX-this.camera.transform.x,this.downButton.y=this.downButton.posY-this.camera.transform.y,this.leftButton.x=this.leftButton.posX-this.camera.transform.x,this.leftButton.y=this.leftButton.posY-this.camera.transform.y,this.rightButton.x=this.rightButton.posX-this.camera.transform.x,this.rightButton.y=this.rightButton.posY-this.camera.transform.y},PlatformState.generateTileMap=function(){this.tilemap=new Kiwi.GameObjects.Tilemap.TileMap(this,"tilemap",this.textures.tiles),this.groundLayer=this.tilemap.getLayerByName("Ground"),this.addChild(this.groundLayer),this.objectLayer=this.tilemap.getLayerByName("Objects"),this.addChild(this.objectLayer),this.slopeLeftLayer=this.tilemap.getLayerByName("SlopeLeft"),this.addChild(this.slopeLeftLayer),this.slopeRightLayer=this.tilemap.getLayerByName("SlopeRight"),this.addChild(this.slopeRightLayer);for(var a=1;a<this.tilemap.tileTypes.length;a++)this.tilemap.tileTypes[a].allowCollisions=Kiwi.Components.ArcadePhysics.ANY},PlatformState.generateForegroundTileMap=function(){this.foregroundRightLayer=this.tilemap.getLayerByName("Foreground"),this.addChild(this.foregroundRightLayer)},PlatformState.update=function(){Kiwi.State.prototype.update.call(this),this.leftDown()?(this.player.scaleX=-1,this.player.physics.velocity.x=-40):this.rightDown()?(this.player.scaleX=1,this.player.physics.velocity.x=40):this.player.physics.velocity.x=0,this.sloping=!1,this.player.x=Math.round(this.player.x),this.player.y=Math.round(this.player.y),this.px=Math.round(this.player.x+this.player.box.bounds.width/2),this.py=this.player.y+this.player.height,this.checkLeftSlope(),this.checkRightSlope();var a=!1;this.sloping?this.player.physics.velocity.y>=0&&(this.jumps=0,a=!0):(this.groundLayer.physics.overlapsTiles(this.player,!0),this.player.physics.isTouching(Kiwi.Components.ArcadePhysics.DOWN)&&(this.jumps=0,a=!0)),a&&this.animatePlayer(0==this.player.physics.velocity.x?"idle":"walking"),this.upDown()?this.jump():this.jumpReleased=!0,this.updateCamera(),this.updateController()},PlatformState.updateCamera=function(){this.camera.transform.x=this.player.x<this.game.stage.width/2?0:this.player.x>this.groundLayer.widthInPixels-this.game.stage.width/2?-(this.groundLayer.widthInPixels-this.game.stage.width):-this.player.x+this.game.stage.width/2,this.camera.transform.y=this.player.y<this.game.stage.height/2?0:this.player.y>this.groundLayer.heightInPixels-this.game.stage.height/2?-(this.groundLayer.heightInPixels-this.game.stage.height):-this.player.y+this.game.stage.height/2},PlatformState.animatePlayer=function(a){this.player.animation.currentAnimation.name!=a&&(this.player.animation.switchTo(a),this.player.animation.play())},PlatformState.jump=function(){this.jumps<this.jumpCount&&this.jumpReleased&&(this.player.physics.velocity.y=-100,this.jumps++,this.animatePlayer("goingUp"),this.jumpReleased=!1)},PlatformState.leftDown=function(){return this.game.input.keyboard.isDown(Kiwi.Input.Keycodes.LEFT)?!0:this.controllerActive&&this.leftButton.isDown?!0:!1},PlatformState.rightDown=function(){return this.game.input.keyboard.isDown(Kiwi.Input.Keycodes.RIGHT)?!0:this.controllerActive&&this.rightButton.isDown?!0:!1},PlatformState.upDown=function(){return this.game.input.keyboard.isDown(Kiwi.Input.Keycodes.UP)?!0:this.controllerActive&&this.upButton.isDown?!0:!1},PlatformState.checkLeftSlope=function(){var a=Math.floor(this.px/this.tileWidth),b=Math.floor(this.py/this.tileHeight),c=this.slopeLeftLayer.getTileFromXY(a,b);if(null!=c&&0!=c.index){var d=a*this.tileWidth,e=b*this.tileHeight;this.sloping=!0;var f=this.px-d,g=this.py-e;if(g>=this.tileHeight-f||this.px-this.player.physics.velocity.x/10>=d+this.tileWidth){var h=e+this.tileHeight-f;return this.player.y=Math.ceil(h-this.player.height),void(this.player.physics.velocity.y=40)}}var i=this.slopeLeftLayer.getTileFromXY(a,b-1);if(null!=i&&0!=i.index){var j=a*this.tileWidth,k=(b-1)*this.tileHeight;this.sloping=!0;var f=this.px-j,h=k+this.tileHeight-f;this.player.y=h-this.player.height,this.player.physics.velocity.y=40}},PlatformState.checkRightSlope=function(){if(!this.sloping){var a=Math.floor(this.px/this.tileWidth),b=Math.floor(this.py/this.tileHeight),c=this.slopeRightLayer.getTileFromXY(a,b);if(null!=c&&0!=c.index){var d=a*this.tileWidth,e=b*this.tileHeight;this.sloping=!0;var f=this.px-d,g=this.py-e;if(g>=f||this.px-this.player.physics.velocity.x/10<=d)return this.player.y=Math.ceil(e+f-this.player.height),void(this.player.physics.velocity.y=40)}var h=this.slopeRightLayer.getTileFromXY(a,b-1);if(null!=h&&0!=h.index){this.sloping=!0;var i=a*this.tileWidth,j=(b-1)*this.tileHeight,f=this.px-i;this.player.y=Math.ceil(j+f-this.player.height),this.player.physics.velocity.y=40}}};